name: ðŸ› Debug Release Automation

on:
  push:
    branches:
      - test/workflow-debug  # SÃ³ roda nesta branch
  workflow_dispatch:        # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  pages: write
  id-token: write
  packages: write
  pull-requests: read

jobs:
  debug-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Debug - InformaÃ§Ãµes do Git
        run: |
          echo "=== GIT INFO ==="
          echo "Current branch: $(git rev-parse --abbrev-ref HEAD)"
          echo "Latest commits:"
          git log --oneline -5
          echo ""
          echo "=== MERGE COMMITS ==="
          git log --merges -3 --pretty=format:"Hash: %H | Subject: %s | Date: %ad" --date=short

      - name: ðŸ” Debug - Simular DetecÃ§Ã£o de VersÃ£o
        id: check-version
        run: |
          echo "=== VERSION CHECK ==="
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"
          
          # Simular versÃ£o anterior (para debug)
          PREVIOUS_VERSION="2.4.0"
          echo "Simulated previous version: $PREVIOUS_VERSION"
          
          # ForÃ§ar detecÃ§Ã£o de mudanÃ§a para teste
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸš€ Debug: Simulating version change from $PREVIOUS_VERSION to $CURRENT_VERSION"

      - name: ðŸ” Debug - InformaÃ§Ãµes do Ãºltimo merge
        id: get-merge-info
        run: |
          echo "=== MERGE INFO DEBUG ==="
          MERGE_COMMIT=$(git log --merges -1 --pretty=format:"%H")
          
          if [ -n "$MERGE_COMMIT" ]; then
            echo "Merge commit found: $MERGE_COMMIT"
            
            FULL_SUBJECT=$(git log -1 --pretty=format:"%s" $MERGE_COMMIT)
            echo "Full subject: $FULL_SUBJECT"
            
            PR_NUMBER=$(echo "$FULL_SUBJECT" | grep -oE '#[0-9]+' | sed 's/#//' || echo "")
            echo "Extracted PR number: $PR_NUMBER"
            
            # Tentar obter tÃ­tulo do PR via API
            if [ -n "$PR_NUMBER" ]; then
              echo "ðŸ” Fetching PR title from GitHub API..."
              PR_TITLE=$(gh pr view $PR_NUMBER --json title --jq '.title' 2>/dev/null || echo "")
              if [ -n "$PR_TITLE" ]; then
                echo "âœ… PR Title from API: $PR_TITLE"
                echo "merge-title=$PR_TITLE" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ API failed, using merge title fallback"
                MERGE_TITLE=$(echo "$FULL_SUBJECT" | sed 's/ (#[0-9]*)$//')
                echo "Fallback title: $MERGE_TITLE"
                echo "merge-title=$MERGE_TITLE" >> $GITHUB_OUTPUT
              fi
            fi
            
            echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ No merge commit found"
            # Para debug, simular dados
            echo "pr-number=123" >> $GITHUB_OUTPUT
            echo "merge-title=feat(Icon): add house simple" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” Debug - Simular ObtenÃ§Ã£o do PR
        if: steps.get-merge-info.outputs.pr-number != ''
        run: |
          echo "=== PR INFO DEBUG ==="
          PR_NUMBER="${{ steps.get-merge-info.outputs.pr-number }}"
          echo "Testing PR number: $PR_NUMBER"
          
          # Simular descriÃ§Ã£o do PR para debug
          cat > pr_description.txt << 'EOF'
          ## ðŸ› Debug Release Automation

          Este Ã© um teste do sistema de release automatizado.

          ### MudanÃ§as
          - ImplementaÃ§Ã£o do workflow de release automÃ¡tico
          - DetecÃ§Ã£o de versÃ£o automÃ¡tica
          - CriaÃ§Ã£o de release notes
          - AtualizaÃ§Ã£o do changelog

          ### Testes realizados
          - âœ… DetecÃ§Ã£o de merge commits
          - âœ… ExtraÃ§Ã£o de informaÃ§Ãµes do PR
          - âœ… FormataÃ§Ã£o de release notes
          EOF
          
          echo "ðŸ“„ Debug PR description created"
          echo "Content:"
          cat pr_description.txt

      - name: ðŸ” Debug - Simular Release Notes
        run: |
          echo "=== RELEASE NOTES DEBUG ==="
          VERSION="${{ steps.check-version.outputs.new-version }}"
          PR_NUMBER="${{ steps.get-merge-info.outputs.pr-number }}"
          MERGE_TITLE="${{ steps.get-merge-info.outputs.merge-title }}"
          
          RELEASE_NAME="v$VERSION"
          echo "Release name: $RELEASE_NAME"
          echo "PR number: $PR_NUMBER"
          echo "PR title: $MERGE_TITLE"
          
          # Mostrar como ficaria o corpo da release
          echo ""
          echo "=== RELEASE BODY PREVIEW ==="
          echo "## ðŸš€ $MERGE_TITLE"
          echo ""
          if [ -f "pr_description.txt" ]; then
            cat pr_description.txt
          fi
          echo ""
          echo "---"
          echo "**Release Date:** $(date +'%Y-%m-%d')"
          echo "**Version:** $VERSION"
          echo "**PR:** #$PR_NUMBER"
          echo ""
          echo "ðŸ·ï¸ Note: GitHub will create tag v$VERSION automatically"
          echo "ðŸ”— Release URL will be: https://github.com/yooga-tecnologia/mantra/releases/tag/v$VERSION"

      - name: ðŸ” Debug - Simular Changelog Update
        run: |
          echo "=== CHANGELOG DEBUG ==="
          VERSION="${{ steps.check-version.outputs.new-version }}"
          MERGE_TITLE="${{ steps.get-merge-info.outputs.merge-title }}"
          PR_NUMBER="${{ steps.get-merge-info.outputs.pr-number }}"
          DATE=$(date +'%Y-%m-%d')
          
          echo "Would update changelog with:"
          echo "Version: $VERSION"
          echo "Date: $DATE"
          echo "Title: $MERGE_TITLE"
          echo "PR: $PR_NUMBER"
          
          echo ""
          echo "=== CHANGELOG ENTRY PREVIEW ==="
          echo "## [$VERSION] â€“ $DATE"
          echo ""
          echo "### ðŸ“‹ $MERGE_TITLE"
          echo "- **Release Notes:** [$VERSION Release Notes](https://github.com/yooga-tecnologia/mantra/releases/tag/v$VERSION)"
          echo "- **Pull Request:** [#$PR_NUMBER](https://github.com/yooga-tecnologia/mantra/pull/$PR_NUMBER)"

      - name: âœ… Debug Summary
        run: |
          echo "=== DEBUG SUMMARY ==="
          echo "âœ… Git info extraction: OK"
          echo "âœ… Version detection: OK"
          echo "âœ… Merge commit parsing: OK"
          echo "âœ… PR info simulation: OK"
          echo "âœ… Release notes formatting: OK"
          echo "âœ… Changelog formatting: OK"
          echo ""
          echo "ðŸŽ‰ Debug workflow completed successfully!"
          echo "Ready to test with real data!"